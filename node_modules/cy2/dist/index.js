var lt=Object.create;var C=Object.defineProperty;var ut=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var Rt=Object.getPrototypeOf,ht=Object.prototype.hasOwnProperty;var ie=(e,t)=>()=>(e&&(t=e(e=0)),t);var w=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),O=(e,t)=>{for(var r in t)C(e,r,{get:t[r],enumerable:!0})},ae=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of mt(t))!ht.call(e,o)&&o!==r&&C(e,o,{get:()=>t[o],enumerable:!(n=ut(t,o))||n.enumerable});return e};var h=(e,t,r)=>(r=e!=null?lt(Rt(e)):{},ae(t||!e||!e.__esModule?C(r,"default",{value:e,enumerable:!0}):r,e)),B=e=>ae(C({},"__esModule",{value:!0}),e);var pe={};O(pe,{error:()=>z,warn:()=>Z});var G,L,Z,z,v=ie(()=>{G=h(require("chalk")),L=h(require("util")),Z=(...e)=>console.warn(G.default.bgYellow.black(`
 WARNING `),L.default.format(...e),`
`),z=(...e)=>console.warn(G.default.bgRed.black(`
 ERROR `),L.default.format(...e),`
`)});var ue={};O(ue,{debugHttpProxy:()=>Vt});var le,Vt,me=ie(()=>{le=require("debug"),Vt=(0,le.debug)("cy2-http-proxy")});var M=w(he=>{var S=he,ft=require("url"),Re=require("util")._extend,Tt=require("requires-port"),Nt=/(^|,)\s*upgrade\s*($|,)/i,_=/^https|wss/;S.isSSL=_;S.setupOutgoing=function(e,t,r,n){e.port=t[n||"target"].port||(_.test(t[n||"target"].protocol)?443:80),["host","hostname","socketPath","pfx","key","passphrase","cert","ca","ciphers","secureProtocol"].forEach(function(a){e[a]=t[n||"target"][a]}),e.method=t.method||r.method,e.headers=Re({},r.headers),t.headers&&Re(e.headers,t.headers),t.auth&&(e.auth=t.auth),t.ca&&(e.ca=t.ca),_.test(t[n||"target"].protocol)&&(e.rejectUnauthorized=typeof t.secure>"u"?!0:t.secure),e.agent=t.agent||!1,e.localAddress=t.localAddress,e.agent||(e.headers=e.headers||{},(typeof e.headers.connection!="string"||!Nt.test(e.headers.connection))&&(e.headers.connection="close"));var o=t[n||"target"],s=o&&t.prependPath!==!1&&o.path||"",i=t.toProxy?r.url:ft.parse(r.url).path||"";return i=t.ignorePath?"":i,e.path=S.urlJoin(s,i),t.changeOrigin&&(e.headers.host=Tt(e.port,t[n||"target"].protocol)&&!St(e.host)?e.host+":"+e.port:e.host),e};S.setupSocket=function(e){return e.setTimeout(0),e.setNoDelay(!0),e.setKeepAlive(!0,0),e};S.getPort=function(e){var t=e.headers.host?e.headers.host.match(/:(\d+)/):"";return t?t[1]:S.hasEncryptedConnection(e)?"443":"80"};S.hasEncryptedConnection=function(e){return Boolean(e.connection.encrypted||e.connection.pair)};S.urlJoin=function(){var e=Array.prototype.slice.call(arguments),t=e.length-1,r=e[t],n=r.split("?"),o;return e[t]=n.shift(),o=[e.filter(Boolean).join("/").replace(/\/+/g,"/").replace("http:/","http://").replace("https:/","https://")],o.push.apply(o,n),o.join("?")};S.rewriteCookieProperty=function e(t,r,n){return Array.isArray(t)?t.map(function(o){return e(o,r,n)}):t.replace(new RegExp("(;\\s*"+n+"=)([^;]+)","i"),function(o,s,i){var a;if(i in r)a=r[i];else if("*"in r)a=r["*"];else return o;return a?s+a:""})};function St(e){return!!~e.indexOf(":")}});var Te=w((It,fe)=>{var Ue=require("url"),Ve=M(),Et=/^201|30(1|2|7|8)$/;fe.exports={removeChunked:function(t,r,n){t.httpVersion==="1.0"&&delete n.headers["transfer-encoding"]},setConnection:function(t,r,n){t.httpVersion==="1.0"?n.headers.connection=t.headers.connection||"close":t.httpVersion!=="2.0"&&!n.headers.connection&&(n.headers.connection=t.headers.connection||"keep-alive")},setRedirectHostRewrite:function(t,r,n,o){if((o.hostRewrite||o.autoRewrite||o.protocolRewrite)&&n.headers.location&&Et.test(n.statusCode)){var s=Ue.parse(o.target),i=Ue.parse(n.headers.location);if(s.host!=i.host)return;o.hostRewrite?i.host=o.hostRewrite:o.autoRewrite&&(i.host=t.headers.host),o.protocolRewrite&&(i.protocol=o.protocolRewrite),n.headers.location=i.format()}},writeHeaders:function(t,r,n,o){var s=o.cookieDomainRewrite,i=o.cookiePathRewrite,a=o.preserveHeaderKeyCase,p,U=function(d,m){m!=null&&(s&&d.toLowerCase()==="set-cookie"&&(m=Ve.rewriteCookieProperty(m,s,"domain")),i&&d.toLowerCase()==="set-cookie"&&(m=Ve.rewriteCookieProperty(m,i,"path")),r.setHeader(String(d).trim(),m))};if(typeof s=="string"&&(s={"*":s}),typeof i=="string"&&(i={"*":i}),a&&n.rawHeaders!=null){p={};for(var l=0;l<n.rawHeaders.length;l+=2){var c=n.rawHeaders[l];p[c.toLowerCase()]=c}}Object.keys(n.headers).forEach(function(d){var m=n.headers[d];a&&p&&(d=p[d]||d),U(d,m)})},writeStatusCode:function(t,r,n){n.statusMessage?(r.statusCode=n.statusCode,r.statusMessage=n.statusMessage):r.statusCode=n.statusCode}}});var Se=w((qt,Ne)=>{var yt=require("http"),Ft=require("https"),Y=Te(),H=M(),wt=require("follow-redirects");Y=Object.keys(Y).map(function(e){return Y[e]});var gt={http:yt,https:Ft};Ne.exports={deleteLength:function(t,r,n){(t.method==="DELETE"||t.method==="OPTIONS")&&!t.headers["content-length"]&&(t.headers["content-length"]="0",delete t.headers["transfer-encoding"])},timeout:function(t,r,n){n.timeout&&t.socket.setTimeout(n.timeout)},XHeaders:function(t,r,n){if(n.xfwd){var o=t.isSpdy||H.hasEncryptedConnection(t),s={for:t.connection.remoteAddress||t.socket.remoteAddress,port:H.getPort(t),proto:o?"https":"http"};["for","port","proto"].forEach(function(i){t.headers["x-forwarded-"+i]=(t.headers["x-forwarded-"+i]||"")+(t.headers["x-forwarded-"+i]?",":"")+s[i]}),t.headers["x-forwarded-host"]=t.headers["x-forwarded-host"]||t.headers.host||""}},stream:function(t,r,n,o,s,i){s.emit("start",t,r,n.target||n.forward);var a=n.followRedirects?wt:gt,p=a.http,U=a.https;if(n.forward){var l=(n.forward.protocol==="https:"?U:p).request(H.setupOutgoing(n.ssl||{},n,t,"forward")),c=y(l,n.forward);if(t.on("error",c),l.on("error",c),(n.buffer||t).pipe(l),!n.target)return r.end()}var d=(n.target.protocol==="https:"?U:p).request(H.setupOutgoing(n.ssl||{},n,t));d.on("socket",function(V){s&&!d.getHeader("expect")&&s.emit("proxyReq",d,t,r,n)}),n.proxyTimeout&&d.setTimeout(n.proxyTimeout,function(){d.abort()}),t.on("aborted",function(){d.abort()});var m=y(d,n.target);t.on("error",m),d.on("error",m);function y(V,F){return function(x){if(t.socket.destroyed&&x.code==="ECONNRESET")return s.emit("econnreset",x,t,r,F),V.abort();i?i(x,t,r,F):s.emit("error",x,t,r,F)}}(n.buffer||t).pipe(d),d.on("response",function(V){if(s&&s.emit("proxyRes",V,t,r),!r.headersSent&&!n.selfHandleResponse)for(var F=0;F<Y.length&&!Y[F](t,r,V,n);F++);r.finished?s&&s.emit("end",t,r,V):(V.on("end",function(){s&&s.emit("end",t,r,V)}),n.selfHandleResponse||V.pipe(r))})}}});var ye=w(($t,Ee)=>{var bt=require("http"),Zt=require("https"),Q=M();Ee.exports={checkMethodAndHeader:function(t,r){if(t.method!=="GET"||!t.headers.upgrade||t.headers.upgrade.toLowerCase()!=="websocket")return r.destroy(),!0},XHeaders:function(t,r,n){if(n.xfwd){var o={for:t.connection.remoteAddress||t.socket.remoteAddress,port:Q.getPort(t),proto:Q.hasEncryptedConnection(t)?"wss":"ws"};["for","port","proto"].forEach(function(s){t.headers["x-forwarded-"+s]=(t.headers["x-forwarded-"+s]||"")+(t.headers["x-forwarded-"+s]?",":"")+o[s]})}},stream:function(t,r,n,o,s,i){var a=function(l,c){return Object.keys(c).reduce(function(d,m){var y=c[m];if(!Array.isArray(y))return d.push(m+": "+y),d;for(var V=0;V<y.length;V++)d.push(m+": "+y[V]);return d},[l]).join(`\r
`)+`\r
\r
`};Q.setupSocket(r),o&&o.length&&r.unshift(o);var p=(Q.isSSL.test(n.target.protocol)?Zt:bt).request(Q.setupOutgoing(n.ssl||{},n,t));return s&&s.emit("proxyReqWs",p,t,r,n,o),p.on("error",U),p.on("response",function(l){l.upgrade||(r.write(a("HTTP/"+l.httpVersion+" "+l.statusCode+" "+l.statusMessage,l.headers)),l.pipe(r))}),p.on("upgrade",function(l,c,d){c.on("error",U),c.on("end",function(){s.emit("close",l,c,d)}),r.on("error",function(){c.end()}),Q.setupSocket(c),d&&d.length&&c.unshift(d),r.write(a("HTTP/1.1 101 Switching Protocols",l.headers)),c.pipe(r).pipe(c),s.emit("open",c),s.emit("proxySocket",c)}),p.end();function U(l){i?i(l,t,r):s.emit("error",l,t,r),r.end()}}}});var Ye=w((er,ve)=>{var{debugHttpProxy:D}=(me(),B(ue)),{error:Wt}=(v(),B(pe)),{omit:Fe,pick:we,isUndefined:Qt}=require("lodash"),We=ve.exports,ge=require("util")._extend,vt=require("url").parse,Qe=require("eventemitter3"),Yt=require("http"),Pt=require("https"),be=Se(),Ze=ye();We.Server=g;function A(e){return function(r){return function(o,s){var i=e==="ws"?this.wsPasses:this.webPasses,a=[].slice.call(arguments),p=a.length-1,U,l;typeof a[p]=="function"&&(l=a[p],p--);var c=r;if(!(a[p]instanceof Buffer)&&a[p]!==s&&(c=ge({},r),ge(c,a[p]),p--),a[p]instanceof Buffer&&(U=a[p]),["target","forward"].forEach(function(m){typeof c[m]=="string"&&(c[m]=vt(c[m]))}),!c.target&&!c.forward)return this.emit("error",new Error("Must provide a proper URL as target"));Qt(i==null?void 0:i.length)&&(Wt("Unexpected error processing the request. Please report the issue and the details below. Set environment variable DEBUG=cy2* and rerun to get more information"),console.error("Request: %o",we(o,"httpVersion","method","url","headers","upgrade","aborted","complete")),console.error("Proxy: type %s, request options: %O",e,Fe(c,"ssl"))),D("applying passes, proxy type: %s, request options: %o",e,Fe(c,"ssl")),D("Request: %o",we(o,"httpVersion","method","url","headers","upgrade","aborted","complete"));for(var d=0;d<i.length;d++)if(i[d](o,s,c,U,this,l)){D('pass halted the loop type "%s", #%d: %s %s',e,d,i[d].name,o.method,o.url);break}}}}We.createRightProxy=A;function g(e){Qe.call(this),e=e||{},e.prependPath=e.prependPath!==!1,this.web=this.proxyRequest=A("web")(e),this.ws=this.proxyWebsocketRequest=A("ws")(e),this.options=e,this.webPasses=Object.keys(be).map(function(t){return be[t]}),this.wsPasses=Object.keys(Ze).map(function(t){return Ze[t]}),this.on("error",this.onError,this)}require("util").inherits(g,Qe);g.prototype.onError=function(e){if(this.listeners("error").length===1)throw e};g.prototype.listen=function(e,t,r){var n=this,o=function(s,i){n.web(s,i)};return this._server=this.options.ssl?Pt.createServer(this.options.ssl,o):Yt.createServer(o),this.options.ws&&this._server.on("upgrade",function(s,i,a){n.ws(s,i,a)}),this._server.listen(e,t,r),this};g.prototype.close=function(e){var t=this;this._server&&this._server.close(r);function r(){t._server=null,e&&e.apply(null,arguments)}};g.prototype.before=function(e,t,r){if(e!=="ws"&&e!=="web")throw new Error("type must be `web` or `ws`");var n=e==="ws"?this.wsPasses:this.webPasses,o=!1;if(n.forEach(function(s,i){s.name===t&&(o=i)}),o===!1)throw new Error("No such pass");n.splice(o,0,r)};g.prototype.after=function(e,t,r){if(e!=="ws"&&e!=="web")throw new Error("type must be `web` or `ws`");var n=e==="ws"?this.wsPasses:this.webPasses,o=!1;if(n.forEach(function(s,i){s.name===t&&(o=i)}),o===!1)throw new Error("No such pass");n.splice(o++,0,r)}});var xe=w((tr,Pe)=>{var P=Ye().Server;function I(e){return new P(e)}P.createProxyServer=I;P.createServer=I;P.createProxy=I;Pe.exports=P});var ke=w((rr,Ce)=>{Ce.exports=xe()});var Ht={};O(Ht,{getCypressCLIBinPath:()=>J,run:()=>ct,spawn:()=>dt});module.exports=B(Ht);var Wr=require("source-map-support/register");var k=require("path");var X=require("debug"),u=(0,X.debug)("cy2"),R=(0,X.debug)("cy2-net");v();async function J(){var e;if(process.env.CYPRESS_PACKAGE_SHELL_SCRIPT)return u("Cypress binary path from CYPRESS_PACKAGE_SHELL_SCRIPT: %s",process.env.CYPRESS_PACKAGE_SHELL_SCRIPT),process.env.CYPRESS_PACKAGE_SHELL_SCRIPT;try{let t=require.resolve("cypress"),r=require("cypress/package.json");if(!r.bin||!((e=r.bin)!=null&&e.cypress))throw new Error("Cannot detect cypress package executable");let n=(0,k.resolve)((0,k.dirname)(t),r.bin.cypress);if(u("Cypress binary path: %s",n),!n)throw new Error("Cannot detect cypress package executable");return n}catch(t){throw z("Cannot detect cypress package executable. Consider using CYPRESS_PACKAGE_SHELL_SCRIPT environment variable. Tried locations: %O",require.resolve.paths("cypress")),t}}var at=h(require("child_process")),pt=require("os");var j={name:"cy2",version:"4.0.6",author:"Andrew Goldis",main:"./dist",typings:"./dist",license:"GPL-3.0-or-later",repository:{type:"git",url:"https://github.com/sorry-cypress/cy2.git"},scripts:{postinstall:"patch-package",build:"run-p tsc esbuild",dev:"run-p watch:*",test:"jest",tsc:"tsc",esbuild:"node ./build.js","watch:tsc":'run-s "tsc --watch --preserveWatchOutput"',"watch:esbuild":"esbuild ./src/*.ts --bundle --platform=node --target=node14 --packages=external --sourcemap=inline --outdir=dist --watch","build-tunnel":"esbuild ./src/tunnel-proxy.ts --bundle --platform=node --target=node14 --packages=external --sourcemap=inline --outdir=dist",release:"release-it","release-ci":"release-it --ci --npm.skipChecks --no-git --no-github --no-increment --npm.publish",clean:"rimraf dist"},files:["bin/*","dist/index.js*","!dist/__tests__","!dist/*.d.ts","!dist/**/*.d.ts","dist/index.d.ts","dist/cypress-wrapper.d.ts","dist/bin-path.d.ts"],bin:{cy2:"bin/cy2"},engines:{node:">=14.17.0"},keywords:["cypress","sorry-cypress","cypress dashboard","cypress ci","cypress parallel","currents"],peerDependencies:{cypress:">=6.7.0"},dependencies:{chalk:"^4.1.2",eventemitter3:"^4.0.0","follow-redirects":"^1.0.0","fp-ts":"^2.13.1","http-terminator":"^3.2.0","https-proxy-agent":"^5.0.1",lodash:"^4.17.21",micromatch:"^4.0.5","patch-package":"^6.5.1","requires-port":"^1.0.0","source-map-support":"^0.5.21",tmp:"^0.2.1"},devDependencies:{"@release-it/conventional-changelog":"^5.1.1","@types/http-proxy":"^1.17.9","@types/jest":"^27.0.1","@types/lodash":"^4.14.191","@types/micromatch":"^4.0.2","@types/node":"^18.11.17",devcert:"^1.2.2",esbuild:"^0.16.13",jest:"^29.3.1","npm-run-all":"^4.1.5","release-it":"^15.6.0",rimraf:"^3.0.2","ts-jest":"^29.0.3",typescript:"^4.9.4"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"CHANGELOG.md"}},git:{requireBranch:"main",commitMessage:"chore: release v${version}"},hooks:{"before:init":"run-s clean build"}},prettier:{singleQuote:!0}};var _e=h(require("fp-ts/Array")),De=require("fp-ts/function"),E=h(require("fp-ts/Option")),Ae=h(require("http")),Ie=require("http-terminator"),qe=require("micromatch");var W=(e,t="base64")=>Buffer.from(e,t).toString();var Je=require("https-proxy-agent");var de=W("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR6ekNDQXJlZ0F3SUJBZ0lKQUxKbGJVZmRBK2s1TUEwR0NTcUdTSWIzRFFFQkN3VUFNRDR4RnpBVkJnTlYKQkFNTURtRndhUzVqZVhCeVpYTnpMbWx2TVFzd0NRWURWUVFHRXdKVlV6RVdNQlFHQTFVRUJ3d05VMkZ1SUVaeQpZVzV6YVhOamJ6QWVGdzB5TWpFeU1UY3dPREUxTkRGYUZ3MHlNekV5TVRjd09ERTFOREZhTUgweEN6QUpCZ05WCkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SWXdGQVlEVlFRSERBMVRZVzRnUm5KaGJuTnAKYzJOdk1SRXdEd1lEVlFRS0RBaElaV3hzYjBoMVlqRVZNQk1HQTFVRUN3d01TR1ZzYkc5SWRXSWdSR1YyTVJjdwpGUVlEVlFRRERBNWhjR2t1WTNsd2NtVnpjeTVwYnpDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDCkFRb0NnZ0VCQU13eVZIellGZmUwUllLVVRzRXpsNjJVYjdXQXFZVUxsZjRrNWFsR21LMjhPYWpHWHFlTGFWd2oKVjc3NXBKVS9ENTg1dzlqbnBwMDRoOTZTVTRtWDNPUVFUN3hKcTRXMlFTSzNHeHRkTkhINHNLWlgrU0FUR2l2MQpYUFZhZlBmbVZsMjcwOVRXNFNBYzZyV2hhclNpdVdVTTU1THhpek9xQ3pYS1RqQWJOam40YStMcDlQaDRST2JTCnYzMjdRQU56U2txcVVocjFlYjhFZ1BkUmNuYXFtYmVES2hZNmlYcmdzTXYzaXB6OUs5QlFKL2wyMVUxNXR5NnYKV2dNSWlrT2hHOEdaOUdhb1RDYUg3Z2xPY1k0djNRVnZldUE4d2YrNXJhQzR1UVV3bDhjeVFBNERGK3VLZWQ2bAp2dkN4aStJNjFnT21ORVcvQ1ZEb2lGZkFBcWVHZnhFQ0F3RUFBYU9Ca0RDQmpUQllCZ05WSFNNRVVUQlBvVUtrClFEQStNUmN3RlFZRFZRUUREQTVoY0drdVkzbHdjbVZ6Y3k1cGJ6RUxNQWtHQTFVRUJoTUNWVk14RmpBVUJnTlYKQkFjTURWTmhiaUJHY21GdWMybHpZMitDQ1FEdWRQbUc0OGUrQ3pBSkJnTlZIUk1FQWpBQU1Bc0dBMVVkRHdRRQpBd0lFOERBWkJnTlZIUkVFRWpBUWdnNWhjR2t1WTNsd2NtVnpjeTVwYnpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DCkFRRUFyS3JDYVpxZ2FWb2hPNUdIN1N2NXlzSm4xYk51VzJlV2pOYUlESW9POWtGTVVXTzk4bFlocmEwQzdtdzcKdm4yalB4QWVQSVpnNDRhV1ZQdXNuSGpqQytJS0FTTndYc05GdWdDSStydnVrakh0Ri9qQ2dNUFhOYXJWVnByYgowK1RyKzNiNys2TU1zT0ZMOUd2Z1JLT2ZGdXJKNTR2Smpkb1Bqem9WWG4vL3M4NVVHbmFlR2VZZGhXMEJncmlNCkFNVkhlMDJzSlJuY3dnWUo4REVab2gzbWo4WGhRQWNpOW92aWYwei94U3luYllGUWVTSUtReFNWcFBQM0N5bUEKVHZxSzdGbENlVytDRWM1TUhOc1BIOTZLelZtUy9XYzBuRFFHNld1ZzRsUU9hdG0zVnIyWFVYZ05ESnVidjJsRgpZVXhmSFl4RStrNExYUVI3czk3R0l2RjUwUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBekRKVWZOZ1Y5N1JGZ3BST3dUT1hyWlJ2dFlDcGhRdVYvaVRscVVhWXJidzVxTVplCnA0dHBYQ05YdnZta2xUOFBuem5EMk9lbW5UaUgzcEpUaVpmYzVCQlB2RW1yaGJaQklyY2JHMTAwY2Zpd3BsZjUKSUJNYUsvVmM5VnA4OStaV1hidlQxTmJoSUJ6cXRhRnF0S0s1WlF6bmt2R0xNNm9MTmNwT01CczJPZmhyNHVuMAorSGhFNXRLL2ZidEFBM05LU3FwU0d2VjV2d1NBOTFGeWRxcVp0NE1xRmpxSmV1Q3d5L2VLblAwcjBGQW4rWGJWClRYbTNMcTlhQXdpS1E2RWJ3Wm4wWnFoTUpvZnVDVTV4amkvZEJXOTY0RHpCLzdtdG9MaTVCVENYeHpKQURnTVgKNjRwNTNxVys4TEdMNGpyV0E2WTBSYjhKVU9pSVY4QUNwNFovRVFJREFRQUJBb0lCQUNONTB3ZmxtdHR3TEd0bApUTkZ3SHpmL0EvRnFxd2o4WEZETkpFRm1qSHdTcVluUy9QcnEwNkU0V3JSSk52amUvZDNSOFY2cjBGeWNSNjY1CmlWM3NUbW9wRTFGSkUwMmx2bWREbktnQ1oyd3Rvck1qc1pxSzl3OFFEOWhvb2pHSGlSVzczaStxTFc2ZzEzNDYKendrWEJGSzBEVCtRUzNqc1lBbzJYYU1wOXgvVzR6bzJYQjdsV0piZ3ZtN1JmYWNwTXlpbERaU1VBMU9MQnJhYwpjdW4rbHduK0V4Z1pXWjR2RVR6Si9vY3dNMEFXT2FRTkdkc3cvL1lSQ29SVEZsVy9VZDBQTk1kU2JpQXhmMEkvClVtM0diNHp6Uk1ibzV1T0syd3BHSkNLNUtQRmM3Nm0vaGRRVVFHUGRjVWlkV3pMR3EyRHdaOUJGNTRqclpROGwKRE84THY4a0NnWUVBL1dCb1Rsa2Y5K3BVb0ROL1p1c0I3M2JqSU5hNTd4TUdsUDdjMUwwZWttR0VKdHNDNlFKVApjRXUzY3BqTTNoU0RjZVNYSFN5aUNKdFB0N3FYOTZVendlOWFkZnpFMldqQ0hYRDdMeXNpdkVRNjFOTHBJQ1d4Cnk4UWxTRG1sVDA3d1ZEN3cyUXY0ZUxITnJoL3BTNEtlMklwb1phaEdCNndFSEcyUXJOS2lkQ01DZ1lFQXprK1IKU3NWRHQ1bG1Od3JyMXhvdFp0WktvSjFIQXJNNVJlbm5wMVorcG1yNGpzNTUwMHR2RjM1c2lYemRkckZKL3pGRwoxUElsb1RKRUpVbWVKNnJZaitpZUoyOUI1SE01bmxPOG1sMFluQjFIMnh3VlQ5SXF6eFd6L09UM2Ivd0QxOGh2Ck0vU0YvTnNOU0FqTUgzUk1IOVpyUUpldG4ycWpjYWlUS1UvRmlUc0NnWUVBejJodW1jdnRGbFMwcDFyZ2JFL3QKaXFkSUwyWjJWNVM4YTVUaEVpZ3BjV3Z2OEpxUkhFbnlJVmRwdUo0Si9iVFBFSmt0ZGcxR0trTndreFprTmF6KwozRDdoVHZuMTdYNEtnRzB1d0tMUDBVc00yWkE0a3o4bjlvUCtmTXZyWFN0aUlhUlFKV3ZlSG5aMXhwYUtzMndlCk9XVzdKWlFFbDEwaEZHQS84S2lQb1A4Q2dZQi82MC9mOTMzc1NkM1p4UmpENzRRMUhpdDVlT3M5bmxpbG84a3gKdFd5anpQRyt3Z0ZCWktWR0FPcFZPU21yM1hOUEdvT2JwMlJ6bFZJeGVIcnFoNER0Z2NNR0duTFZyaWdNcGtqcgp3VXR3Q0t1MERLNmVKbWJLcmQ5Q3I4bElFdzlpN1BFZVdyLzFMdkVHT0FZd2ZwQndzU2NoRHFybGpGNDVLOWZMCkpwNEpYd0tCZ0VLQjQxazhQSUNmQnZ1QjdobUdmNFpKay8yc3hubGFtQkV4a0lKTWhrbmVpWi94YkNXVVJ1RHMKaW1tTXYxaytzK2trLzZTc2VRb1dNTTZvVCtwUVJzN2NiUHNkbmNPNFJKY2dTaXBZQlNoRWtjYUZSdVp2NkdqVwpqN0RnQ0VRZSs2SkdrMVdKakxTbGRobUxwdEg2K2tuSXcxcUdzUEVwMEk4VDVhbDZleE44Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0t"),ce=W("LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBekRKVWZOZ1Y5N1JGZ3BST3dUT1hyWlJ2dFlDcGhRdVYvaVRscVVhWXJidzVxTVplCnA0dHBYQ05YdnZta2xUOFBuem5EMk9lbW5UaUgzcEpUaVpmYzVCQlB2RW1yaGJaQklyY2JHMTAwY2Zpd3BsZjUKSUJNYUsvVmM5VnA4OStaV1hidlQxTmJoSUJ6cXRhRnF0S0s1WlF6bmt2R0xNNm9MTmNwT01CczJPZmhyNHVuMAorSGhFNXRLL2ZidEFBM05LU3FwU0d2VjV2d1NBOTFGeWRxcVp0NE1xRmpxSmV1Q3d5L2VLblAwcjBGQW4rWGJWClRYbTNMcTlhQXdpS1E2RWJ3Wm4wWnFoTUpvZnVDVTV4amkvZEJXOTY0RHpCLzdtdG9MaTVCVENYeHpKQURnTVgKNjRwNTNxVys4TEdMNGpyV0E2WTBSYjhKVU9pSVY4QUNwNFovRVFJREFRQUJBb0lCQUNONTB3ZmxtdHR3TEd0bApUTkZ3SHpmL0EvRnFxd2o4WEZETkpFRm1qSHdTcVluUy9QcnEwNkU0V3JSSk52amUvZDNSOFY2cjBGeWNSNjY1CmlWM3NUbW9wRTFGSkUwMmx2bWREbktnQ1oyd3Rvck1qc1pxSzl3OFFEOWhvb2pHSGlSVzczaStxTFc2ZzEzNDYKendrWEJGSzBEVCtRUzNqc1lBbzJYYU1wOXgvVzR6bzJYQjdsV0piZ3ZtN1JmYWNwTXlpbERaU1VBMU9MQnJhYwpjdW4rbHduK0V4Z1pXWjR2RVR6Si9vY3dNMEFXT2FRTkdkc3cvL1lSQ29SVEZsVy9VZDBQTk1kU2JpQXhmMEkvClVtM0diNHp6Uk1ibzV1T0syd3BHSkNLNUtQRmM3Nm0vaGRRVVFHUGRjVWlkV3pMR3EyRHdaOUJGNTRqclpROGwKRE84THY4a0NnWUVBL1dCb1Rsa2Y5K3BVb0ROL1p1c0I3M2JqSU5hNTd4TUdsUDdjMUwwZWttR0VKdHNDNlFKVApjRXUzY3BqTTNoU0RjZVNYSFN5aUNKdFB0N3FYOTZVendlOWFkZnpFMldqQ0hYRDdMeXNpdkVRNjFOTHBJQ1d4Cnk4UWxTRG1sVDA3d1ZEN3cyUXY0ZUxITnJoL3BTNEtlMklwb1phaEdCNndFSEcyUXJOS2lkQ01DZ1lFQXprK1IKU3NWRHQ1bG1Od3JyMXhvdFp0WktvSjFIQXJNNVJlbm5wMVorcG1yNGpzNTUwMHR2RjM1c2lYemRkckZKL3pGRwoxUElsb1RKRUpVbWVKNnJZaitpZUoyOUI1SE01bmxPOG1sMFluQjFIMnh3VlQ5SXF6eFd6L09UM2Ivd0QxOGh2Ck0vU0YvTnNOU0FqTUgzUk1IOVpyUUpldG4ycWpjYWlUS1UvRmlUc0NnWUVBejJodW1jdnRGbFMwcDFyZ2JFL3QKaXFkSUwyWjJWNVM4YTVUaEVpZ3BjV3Z2OEpxUkhFbnlJVmRwdUo0Si9iVFBFSmt0ZGcxR0trTndreFprTmF6KwozRDdoVHZuMTdYNEtnRzB1d0tMUDBVc00yWkE0a3o4bjlvUCtmTXZyWFN0aUlhUlFKV3ZlSG5aMXhwYUtzMndlCk9XVzdKWlFFbDEwaEZHQS84S2lQb1A4Q2dZQi82MC9mOTMzc1NkM1p4UmpENzRRMUhpdDVlT3M5bmxpbG84a3gKdFd5anpQRyt3Z0ZCWktWR0FPcFZPU21yM1hOUEdvT2JwMlJ6bFZJeGVIcnFoNER0Z2NNR0duTFZyaWdNcGtqcgp3VXR3Q0t1MERLNmVKbWJLcmQ5Q3I4bElFdzlpN1BFZVdyLzFMdkVHT0FZd2ZwQndzU2NoRHFybGpGNDVLOWZMCkpwNEpYd0tCZ0VLQjQxazhQSUNmQnZ1QjdobUdmNFpKay8yc3hubGFtQkV4a0lKTWhrbmVpWi94YkNXVVJ1RHMKaW1tTXYxaytzK2trLzZTc2VRb1dNTTZvVCtwUVJzN2NiUHNkbmNPNFJKY2dTaXBZQlNoRWtjYUZSdVp2NkdqVwpqN0RnQ0VRZSs2SkdrMVdKakxTbGRobUxwdEg2K2tuSXcxcUdzUEVwMEk4VDVhbDZleE44Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg=="),K=process.env.CY2_EMPTY_CA?"":W("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMrRENDQWVBQ0NRRHVkUG1HNDhlK0N6QU5CZ2txaGtpRzl3MEJBUXNGQURBK01SY3dGUVlEVlFRRERBNWgKY0drdVkzbHdjbVZ6Y3k1cGJ6RUxNQWtHQTFVRUJoTUNWVk14RmpBVUJnTlZCQWNNRFZOaGJpQkdjbUZ1YzJsegpZMjh3SGhjTk1qSXhNakUzTURneE5EQTFXaGNOTWpNeE1qQTRNRGd4TkRBMVdqQStNUmN3RlFZRFZRUUREQTVoCmNHa3VZM2x3Y21WemN5NXBiekVMTUFrR0ExVUVCaE1DVlZNeEZqQVVCZ05WQkFjTURWTmhiaUJHY21GdWMybHoKWTI4d2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUMyY1ZFWlRSb0E1czMrY2dRSAo1SDRkdysyYnR0S0xidEVneC90bzdwVzAwNlMvL3NpQTBtRWlMUHpvcXJjTXZsamgyVHJ2YmhDT1gzc05xWWlSCjZQL3VMNUxXUkVRKzgyTGxDNHg3WTNvYlFqZGVZd3RCbHNlUXRvNmQ2b3I1eCtFNm1BRURvbU5sclZkT2U5U3AKNU9iRmx4Qk9ZOGlzYXJhN1l1MnM0Q0RmcHlwa0NMRmxEWkJtZHBjY1hEMDNUNGtXVE43TnRyTFE5UmxsN1J0Qgp3UHhTeWdROTBvYUZ5TUF1RkxRSGZ1K095NHdqZmhpVWt1ZkV5WHk4T25NZGNNdjVmdXJrYlJQM0Joa0tWOVk3ClllUi80OFNwcDlUUjJNZEtNNkVtU2FnSkNiWC9TdEtmZmVEUi9UQnNEOXJuTDBVa1ZOaWJzTlhqcVF0cSs3UXAKdU8zdEFnTUJBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUd5bndldGk5T2VFd0dkMGN4SVhFQUFyRHZpZgp2ekVSamh3dzVKOWFqZFU4Wk5heHlBVG1LN1lMa2U2b2NDZE1zU2hHU1lIWFp6UFZZRjk3cFFwTVM1WTdrbVBHCk9pU29Ec0duVUdWTEdLTE05TTJNcmxMN3NYeTl4UUZFSUNEbk9TMzZFWHhvOHpHK0RsUzZuMVFmeU9saThtaHIKUjhvRyttS0I1MDh0ejVPS1VYUXNXNG4rRE1XeE9RaXBGVXEvVGhYSkROb05iWlEwL2tKVUh1bTFSS3J6MHhpZgphWXJ6bGJDU1RkQ1VxWXQ1YVhDYml6aGtSQ2dhT2M4NWxqcXBZT3F5THhUSEVySWZySWE1U1NJRVZWanlTVnNGCnFXNTRoV0EwWmY4ZHVicEFRV2tLVEY5T1NvdEtnVENyVmU0RGdub2lwTlYyenViVm0raUIybFBEQmZRPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==");var Me=h(ke());v();var T=new Map;async function He(){R("Stopping interceptors"),await Promise.all(Array.from(T.values()).map((e,t,r)=>new Promise(n=>e.close(()=>{R("Stopped interceptor %d/%d",t+1,r.length),n()})))),T.clear()}async function Oe({target:e,upstreamProxy:t}){if(T.has("upstream"))return R("Using interceptor with upstream routing",t.toString(),e),T.get("upstream");R("Creating interceptor with upstream routing path: %s -> %s",t.toString(),e);let r=new Je.HttpsProxyAgent({protocol:t.protocol,host:t.hostname,port:t.port,path:t.pathname});return T.set("upstream",await Xe({target:e,agent:r})),T.get("upstream")}async function Be({target:e}){return T.has("direct")?(R("Using interceptor with direct routing"),T.get("direct")):(R("Creating interceptor with direct routing path: %s",e),T.set("direct",await Xe({target:e})),T.get("direct"))}function Xe({target:e,agent:t}){return new Promise(r=>{R("Creating interceptor for %s",e);let n=Me.createProxyServer({target:e,changeOrigin:!0,followRedirects:!0,agent:t,ssl:{key:ce,cert:de}}).on("error",o=>{let s=Boolean(t)?"upstream proxy":"direct";R("Interceptor of type %s error: %s",s,o),Z("Error connecting to %s: %s",e,o.message)});n.listen(0,void 0,()=>r(n))})}var q=h(require("net"));function Ge({socket:e,port:t,hostname:r}){let n=q.default.connect(t,r);n.on("ready",function(){e.pipe(n),n.pipe(e),e.write(`HTTP/1.1 200 OK\r
\r
`)}),n.on("error",function(){n.end(),n.destroy(),e.end(),e.destroy()}),e.on("error",function(){e.end(),e.destroy(),n.end(),n.destroy()})}function Le({socket:e,port:t}){let r=q.default.connect(t);r.on("ready",()=>{r.pipe(e),e.pipe(r),e.write(`HTTP/1.1 200 OK\r
\r
`)}),r.on("error",()=>{e.end(),e.destroy()}),r.on("end",()=>{e.end(),e.destroy()}),e.on("error",()=>{r.end(),r.destroy()}),e.on("end",()=>{r.end(),r.destroy()})}var ze=h(require("http")),je=h(require("https"));function Ke(e,t,r){R("Proxy chain to upstream for",e.url),r.protocol==="https:"?je.default:ze.default.request({method:"CONNECT",path:e.url,headers:e.headers,agent:!1,hostname:r.hostname,port:r.port,protocol:r.protocol}).once("upgrade",o).once("connect",s).once("error",i).once("response",n).end();function n(a){a.upgrade=!0}function o(a,p){process.nextTick(function(){s(a,p)})}function s(a,p){p.setNoDelay(!0),p.removeAllListeners(),a.statusCode===200?(t.pipe(p),p.pipe(t),t.write(`HTTP/1.1 200 OK\r
\r
`)):(t.write(`HTTP/1.1 500 SERVER ERROR\r
\r
`),t.end(),t.destroy()),p.on("error",()=>{p.end(),p.destroy(),t.end(),t.destroy()}),t.on("error",()=>{p.end(),p.destroy(),t.end(),t.destroy()})}function i(a){console.error("Upstream proxy connection error",a),t.end(),t.destroy()}}async function $({target:e="https://cy.currents.dev",upstreamProxy:t=null,envVariables:r={}}){return new Promise((n,o)=>{var U;let s=xt(t,e,(U=r.NO_PROXY)==null?void 0:U.split(",")),i=Ae.default.createServer(),a=(0,Ie.createHttpTerminator)({server:i});async function p(){R("Stopping proxy"),await a.terminate()}i.on("connect",s).listen(0,()=>{let l=i.address();if(!Jt(l)){o(new Error("Unable to detect proxy address"));return}R("Proxy is listening on port %d",l.port),n({stop:async()=>{await He(),await p(),R("Stopped proxy + interceptors")},port:l.port})})})}var xt=(e,t,r=[])=>function(o,s){if(R("Connection request: %s",o.url),!o.url)throw new Error("Missing req.url in connect handler");let[i,a]=o.url.split(":",2);if(kt(i)){Ct({target:t,hostname:i,socket:s,upstreamProxy:e,noProxy:r});return}if(e&&$e(i,r)){Ke(o,s,e);return}Ge({socket:s,port:parseInt(a,10),hostname:i})};async function Ct({target:e,hostname:t,socket:r,upstreamProxy:n=null,noProxy:o=[]}){let i=(await(0,De.pipe)(n,E.fromNullable,E.filter(()=>$e(new URL(e).hostname,o)),E.map(a=>Oe({upstreamProxy:a,target:e})),E.getOrElse(()=>Be({target:e}))))._server.address().port;R('Intercepting request to "%s" via port: %d',t,i),Le({socket:r,port:i})}function $e(e,t=[]){let r=_e.isEmpty(t)?!0:!(0,qe.isMatch)(e,t);return R('Should "%s" use upstream proxy with NO_PROXY %s: %s',e,t,r),r}function kt(e){return e===W("YXBpLmN5cHJlc3MuaW8=")}function Jt(e){return typeof e=="object"&&e!==null}var ee=require("fp-ts/function"),f=h(require("fp-ts/Option")),ot=h(require("fs")),b=require("lodash"),st=h(require("tmp")),te=require("url");var et=require("fp-ts/function"),N=h(require("fp-ts/Option")),tt=h(require("fs"));var rt=()=>(0,et.pipe)(N.fromNullable(process.env.NODE_EXTRA_CA_CERTS),N.chain(e=>N.tryCatch(()=>tt.default.readFileSync(e))),N.map(e=>(u("Augmenting NODE_EXTRA_CA_CERTS: %s",process.env.NODE_EXTRA_CA_CERTS),`${K}
${e}`)),N.getOrElse(()=>K));v();var nt=e=>e==="false"||e==="0"||!e;function re(){let e=(0,b.pick)(process.env,["NO_PROXY","HTTP_PROXY","HTTPS_PROXY","no_proxy","http_proxy","https_proxy","npm_config_proxy","npm_config_https_proxy","npm_config_noproxy"]);u("Original environment variables %o",e),[["http_proxy","HTTP_PROXY"],["https_proxy","HTTPS_PROXY"],["no_proxy","NO_PROXY"]].forEach(([r,n])=>{nt(e[r])||(u("Copying lowercase %s to %s",r,n),e[n]=e[r])}),[["npm_config_proxy","HTTP_PROXY"],["npm_config_https_proxy","HTTPS_PROXY"]].forEach(([r,n])=>{!nt(e[r])&&(0,b.isUndefined)(e[n])&&(u("Using npm's %s as %s",r,n),e[n]=e[r])});let t={https_proxy:void 0,http_proxy:void 0,npm_config_proxy:void 0,npm_config_https_proxy:void 0,NO_PROXY:e.NO_PROXY,HTTP_PROXY:e.HTTP_PROXY,HTTPS_PROXY:e.HTTPS_PROXY};return u("Sanitized environment variables %o",t),t}function ne({port:e}){let t=rt(),r=st.default.fileSync();return ot.default.writeFileSync(r.name,t),{caPath:r.name,proxyURL:`http://127.0.0.1:${e}`}}function oe(e){return(0,ee.pipe)(f.fromNullable(e.HTTPS_PROXY),f.map(t=>({source:"HTTPS_PROXY",value:t})),f.alt(()=>(0,ee.pipe)(f.fromNullable(e.HTTP_PROXY),f.map(t=>({source:"HTTP_PROXY",value:t})))),f.map(t=>(Mt(t.source,new te.URL(t.value)),new te.URL(t.value))),f.fold(()=>null,t=>(u("Using upstream proxy %o",t),t)))}function Mt(e,t){t.protocol==="http:"&&e==="HTTPS_PROXY"&&Z("Mismatch between protocol 'http' and env variable HTTPS_PROXY: %s. Use HTTP_PROXY instead.",t),t.protocol==="https:"&&e==="HTTP_PROXY"&&Z("Mismatch between protocol 'https' and env variable HTTP_PROXY: %s. USE HTTPS_PROXY instead.",t)}function se(e,t){return(0,b.chain)({...t,HTTP_PROXY:void 0,HTTPS_PROXY:e.proxyURL,NODE_EXTRA_CA_CERTS:e.caPath}).tap(r=>u("Resolved proxy environment variables %o",r)).value()}function it(e){Object.entries(e).forEach(([t,r])=>{if((0,b.isUndefined)(r)){u("Deleting env %s",t),process.env[t]=r,delete process.env[t];return}u("Setting env %s=%s",t,r),process.env[t]=r})}async function dt(e){u("Cypress API URL: %s",e),u("Package version: %s",j.version);let[,,...t]=process.argv,r=await J(),n=(0,pt.platform)()==="win32",o=n?"node":r,s=n?[r,...t]:t;u("Running cypress: %o",[o,...s]);let i=re(),a=oe(i),{port:p}=await $({target:e,upstreamProxy:a,envVariables:i});at.default.spawn(o,s,{stdio:"inherit",env:{...process.env,...se(ne({port:p}),i)}}).on("exit",U=>{process.exit(U??1)})}async function ct(e,t){if(u("Cypress API URL: %s",e),u("Package version: %s",j.version),!e)throw new Error("Missing API URL");let r=require("cypress"),n={...process.env},o=re(),s=oe(o),{port:i,stop:a}=await $({target:e,upstreamProxy:s,envVariables:o});try{return it(se(ne({port:i}),o)),await r.run(t)}finally{process.env=n,await a()}}0&&(module.exports={getCypressCLIBinPath,run,spawn});
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map
